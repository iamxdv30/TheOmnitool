{% extends "base.html" %}
{% block title %}US Tax Calculator{% endblock %}
{% block styles %}{% endblock %}
{% block content %}

<div class="tax-calculator">
    <h1>US Tax Calculator</h1>

    <form method="POST" action="{{ url_for('tax_calculator_route') }}">
        <div id="itemsContainer">
            {% for i in range(1, (data['item_count']|default(1))|int + 1) %}
            <div class="item-row">
                <label for="item_price_{{ i }}">Item {{ i }} Price:</label>
                <input type="number" step="0.01" name="item_price_{{ i }}" id="item_price_{{ i }}" value="{{ data['item_price_' ~ i]|default('') }}" required>

                <label for="item_tax_rate_{{ i }}">Item {{ i }} Tax Rate (%):</label>
                <input type="number" step="0.01" name="item_tax_rate_{{ i }}" id="item_tax_rate_{{ i }}" value="{{ data['item_tax_rate_' ~ i]|default('') }}" required>

                <label for="item_discount_{{ i }}">Item {{ i }} Discount:</label>
                <input type="number" step="0.01" name="item_discount_{{ i }}" id="item_discount_{{ i }}" value="{{ data['item_discount_' ~ i]|default('0') }}">
            </div>
            {% endfor %}
        </div>

        <button type="button" id="addItem">Add Item</button>

        <div class="shipping-section">
            <h3>Shipping</h3>
            <label for="has_shipping">Apply Shipping?</label>
            <select name="has_shipping" id="has_shipping">
                <option value="N" {% if data.has_shipping != 'Y' %}selected{% endif %}>No</option>
                <option value="Y" {% if data.has_shipping == 'Y' %}selected{% endif %}>Yes</option>
            </select>

            <div id="shipping_section" {% if data.has_shipping != 'Y' %}style="display: none;"{% endif %}>
                <label for="shipping_cost">Shipping Cost:</label>
                <input type="number" step="0.01" name="shipping_cost" id="shipping_cost" value="{{ data.shipping_cost|default('') }}">

                <label for="shipping_taxable">Is Shipping Taxable?</label>
                <select name="shipping_taxable" id="shipping_taxable">
                    <option value="N" {% if data.shipping_taxable != 'Y' %}selected{% endif %}>No</option>
                    <option value="Y" {% if data.shipping_taxable == 'Y' %}selected{% endif %}>Yes</option>
                </select>

                <div id="shipping_tax_rate_section" {% if data.shipping_taxable != 'Y' %}style="display: none;"{% endif %}>
                    <label for="shipping_tax_rate">Shipping Tax Rate (%):</label>
                    <input type="number" step="0.01" name="shipping_tax_rate" id="shipping_tax_rate" value="{{ data.shipping_tax_rate|default('') }}">
                </div>
            </div>
        </div>

        <input type="submit" value="Calculate Tax">
    </form>

    {% if result %}
    <div class="result-container">
        <h2>Results</h2>
        <p><strong>Item Total:</strong> {{ result.item_total }}</p>
        <p><strong>Discount Total:</strong> {{ result.discount_total }}</p>
        <p><strong>Total Tax:</strong> {{ result.total_tax }}</p>
        <p><strong>Total Amount:</strong> {{ result.total_amount }}</p>

        <div class="tax-breakdown">
            <h3>Tax Breakdown:</h3>
            <ul>
            {% for tax in result.tax_breakdown %}
                <li>Tax for Item {{ tax.item }}: {{ tax.tax }}</li>
            {% endfor %}
            {% if result.shipping_tax %}
                <li>Shipping Tax: {{ result.shipping_tax }}</li>
            {% endif %}
            </ul>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('itemsContainer');
    const addItemButton = document.getElementById('addItem');
    let itemCount = {{ (data['item_count']|default(1))|int }};

    addItemButton.addEventListener('click', function() {
        itemCount++;
        const newItem = document.createElement('div');
        newItem.className = 'item-row';
        newItem.innerHTML = `
            <label for="item_price_${itemCount}">Item ${itemCount} Price:</label>
            <input type="number" step="0.01" name="item_price_${itemCount}" id="item_price_${itemCount}" required>

            <label for="item_tax_rate_${itemCount}">Item ${itemCount} Tax Rate (%):</label>
            <input type="number" step="0.01" name="item_tax_rate_${itemCount}" id="item_tax_rate_${itemCount}" required>

            <label for="item_discount_${itemCount}">Item ${itemCount} Discount:</label>
            <input type="number" step="0.01" name="item_discount_${itemCount}" id="item_discount_${itemCount}" value="0">
        `;
        itemsContainer.appendChild(newItem);
    });

    const hasShippingSelect = document.getElementById('has_shipping');
    const shippingSection = document.getElementById('shipping_section');
    const shippingTaxableSelect = document.getElementById('shipping_taxable');
    const shippingTaxRateSection = document.getElementById('shipping_tax_rate_section');

    hasShippingSelect.addEventListener('change', function() {
        shippingSection.style.display = this.value === 'Y' ? 'block' : 'none';
    });

    shippingTaxableSelect.addEventListener('change', function() {
        shippingTaxRateSection.style.display = this.value === 'Y' ? 'block' : 'none';
    });
});
</script>

{% endblock %}