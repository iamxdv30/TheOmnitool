{% extends "base.html" %}
{% block title %}Tax Calculator{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tax_calculator.css') }}">
{% endblock %}

{% block scripts %}
<!-- Load utility JS files -->
<script src="{{ url_for('static', filename='js/utils/common.js') }}"></script>
<!-- Load page-specific JS -->
<script src="{{ url_for('static', filename='js/pages/tax_calculator.js') }}"></script>
{% endblock %}
{% block content %}

<div class="tax-calculator">
    <h1>Tax Calculator</h1>

    <form id="taxForm" method="POST" action="{{ url_for('tool.tax_calculator_route') }}">
        <div class="calculator-selection">
            <label for="calculator-type">Select Country:</label>
            <select id="calculator-type" name="calculator_type"
                    data-ca-calculator-url="{{ url_for('tool.canada_tax_calculator') }}"
                    data-us-calculator-url="{{ url_for('tool.tax_calculator_route') }}">
                <option value="us">United States</option>
                <option value="canada">Canada</option>
            </select>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" name="is_sales_before_tax" {% if data.is_sales_before_tax|default(true) %}checked{% endif %}> 
                Apply Discounts Before Tax
            </label>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" name="discount_is_taxable" {% if data.discount_is_taxable|default(true) %}checked{% endif %}> 
                Discounts Are Taxable
            </label>
        </div>

        <div id="itemsContainer">
            <h3>Items</h3>
            {% for i in range(1, (data.item_count|default(1))|int + 1) %}
            <div class="item">
                <label for="item_price_{{ i }}">Item {{ i }} Price:</label>
                <input type="number" step="0.0001" name="item_price_{{ i }}" value="{{ data.get('item_price_' ~ i, '') }}" required>
                <label for="item_tax_rate_{{ i }}">Tax Rate (%):</label>
                <input type="number" step="0.0001" name="item_tax_rate_{{ i }}" value="{{ data.get('item_tax_rate_' ~ i, '') }}" required>
            </div>
            {% endfor %}
        </div>
        <button type="button" id="addItemBtn">Add Item</button>

        <div id="discountsContainer">
            <h3>Discounts</h3>
            {% for i in range(1, (data.discount_count|default(0))|int + 1) %}
            <div class="discount">
                <label for="discount_amount_{{ i }}">Discount {{ i }} Amount:</label>
                <input type="number" step="0.0001" name="discount_amount_{{ i }}" value="{{ data.get('discount_amount_' ~ i, '') }}">
                <label for="is_discount_taxable_{{ i }}">Is Taxable?</label>
            </div>
            {% endfor %}
        </div>
        <button type="button" id="addDiscountBtn">Add Discount</button>

        <div class="shipping-section">
            <h3>Shipping</h3>
            <label for="shipping_cost">Shipping Cost:</label>
            <input type="number" step="0.0001" name="shipping_cost" value="{{ data.shipping_cost|default('') }}">
            <label for="shipping_taxable">Is Shipping Taxable?</label>
            <select name="shipping_taxable">
                <option value="N" {% if data.shipping_taxable == 'N' %}selected{% endif %}>No</option>
                <option value="Y" {% if data.shipping_taxable == 'Y' %}selected{% endif %}>Yes</option>
            </select>
            <div id="shipping_tax_rate_section" {% if data.shipping_taxable != 'Y' %}style="display: none;"{% endif %}>
                <label for="shipping_tax_rate">Shipping Tax Rate (%):</label>
                <input type="number" step="0.0001" name="shipping_tax_rate" value="{{ data.shipping_tax_rate|default('') }}">
            </div>
        </div>

        <button type="submit">Calculate Tax</button>
    </form>

    {% if result %}
    <div class="result-container">
        <h2>Results</h2>
        <p><strong>Item Total:</strong> ${{ "%.2f"|format(result.item_total) }}</p>
        <p><strong>Discount Total:</strong> ${{ "%.2f"|format(result.discount_total) }}</p>
        <p><strong>Shipping Cost:</strong> ${{ "%.2f"|format(result.shipping_cost) }}</p>
        <p><strong>Total Tax:</strong> ${{ "%.2f"|format(result.total_tax) }}</p>
        <p><strong>Total Amount:</strong> ${{ "%.2f"|format(result.total_amount) }}</p>
        
        <div class="tax-breakdown">
            <h3>Tax Breakdown:</h3>
            <ul>
            {% for tax in result.tax_breakdown %}
                <li>{{ tax.item }}: ${{ "%.2f"|format(tax.tax) }}</li>
            {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
</div>

<!-- JavaScript has been moved to modular files:
     - common.js: General utilities
     - tax_calculator.js: Page-specific functionality
-->
{% endblock %}