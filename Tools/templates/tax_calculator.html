{% extends "base.html" %}
{% block title %}Tax Calculator{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tax_calculator.css') }}">
{% endblock %}
{% block content %}

<div class="tax-calculator">
    <h1>Tax Calculator</h1>

    <form id="taxForm" method="POST" action="{{ url_for('tax_calculator_route') }}">
        <div class="calculator-selection">
            <label for="calculator-type">Select Country:</label>
            <select id="calculator-type" name="calculator_type" onchange="handleCalculatorChange(this)">
                <option value="us">United States</option>
                <option value="canada">Canada</option>
            </select>
        </div>

        <div id="itemsContainer">
            <h3>Items</h3>
            {% for i in range(1, (data.item_count|default(1))|int + 1) %}
            <div class="item">
                <label for="item_price_{{ i }}">Item {{ i }} Price:</label>
                <input type="number" step="0.01" name="item_price_{{ i }}" value="{{ data.get('item_price_' ~ i, '') }}" required>
                <label for="item_tax_rate_{{ i }}">Tax Rate (%):</label>
                <input type="number" step="0.01" name="item_tax_rate_{{ i }}" value="{{ data.get('item_tax_rate_' ~ i, '') }}" required>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addItem()">Add Item</button>

        <div id="discountsContainer">
            <h3>Discounts</h3>
            {% for i in range(1, (data.discount_count|default(0))|int + 1) %}
            <div class="discount">
                <label for="discount_amount_{{ i }}">Discount {{ i }} Amount:</label>
                <input type="number" step="0.01" name="discount_amount_{{ i }}" value="{{ data.get('discount_amount_' ~ i, '') }}">
                <label for="is_discount_taxable_{{ i }}">Is Taxable?</label>
                <select name="is_discount_taxable_{{ i }}">
                    <option value="N" {% if data.get('is_discount_taxable_' ~ i) == 'N' %}selected{% endif %}>No</option>
                    <option value="Y" {% if data.get('is_discount_taxable_' ~ i) == 'Y' %}selected{% endif %}>Yes</option>
                </select>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addDiscount()">Add Discount</button>

        <div class="shipping-section">
            <h3>Shipping</h3>
            <label for="shipping_cost">Shipping Cost:</label>
            <input type="number" step="0.01" name="shipping_cost" value="{{ data.shipping_cost|default('') }}">
            <label for="shipping_taxable">Is Shipping Taxable?</label>
            <select name="shipping_taxable" onchange="toggleShippingTaxRate()">
                <option value="N" {% if data.shipping_taxable == 'N' %}selected{% endif %}>No</option>
                <option value="Y" {% if data.shipping_taxable == 'Y' %}selected{% endif %}>Yes</option>
            </select>
            <div id="shipping_tax_rate_section" {% if data.shipping_taxable != 'Y' %}style="display: none;"{% endif %}>
                <label for="shipping_tax_rate">Shipping Tax Rate (%):</label>
                <input type="number" step="0.01" name="shipping_tax_rate" value="{{ data.shipping_tax_rate|default('') }}">
            </div>
        </div>

        <button type="submit">Calculate Tax</button>
    </form>

    {% if result %}
    <div class="result-container">
        <h2>Results</h2>
        <p><strong>Item Total:</strong> ${{ "%.2f"|format(result.item_total) }}</p>
        <p><strong>Discount Total:</strong> ${{ "%.2f"|format(result.discount_total) }}</p>
        <p><strong>Shipping Cost:</strong> ${{ "%.2f"|format(result.shipping_cost) }}</p>
        <p><strong>Total Tax:</strong> ${{ "%.2f"|format(result.total_tax) }}</p>
        <p><strong>Total Amount:</strong> ${{ "%.2f"|format(result.total_amount) }}</p>
        
        <div class="tax-breakdown">
            <h3>Tax Breakdown:</h3>
            <ul>
            {% for tax in result.tax_breakdown %}
                <li>{{ tax.item }}: ${{ "%.2f"|format(tax.tax) }}</li>
            {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
</div>

<script>

    function handleCalculatorChange(selectElement) {
        if (selectElement.value === 'canada') {
            document.getElementById('taxForm').action = "{{ url_for('canada_tax_calculator') }}";
            document.getElementById('taxForm').submit();
        } else {
            document.getElementById('taxForm').action = "{{ url_for('tax_calculator_route') }}";
        }
    }

    let itemCount = {{ (data.item_count|default(1))|int }};
    let discountCount = {{ (data.discount_count|default(0))|int }};

    function addItem() {
        itemCount++;
        const itemsContainer = document.getElementById('itemsContainer');
        const newItem = document.createElement('div');
        newItem.classList.add('item');
        newItem.innerHTML = `
            <label for="item_price_${itemCount}">Item ${itemCount} Price:</label>
            <input type="number" step="0.01" name="item_price_${itemCount}" required>
            <label for="item_tax_rate_${itemCount}">Tax Rate (%):</label>
            <input type="number" step="0.01" name="item_tax_rate_${itemCount}" required>
        `;
        itemsContainer.appendChild(newItem);
    }

    function addDiscount() {
        discountCount++;
        const discountsContainer = document.getElementById('discountsContainer');
        const newDiscount = document.createElement('div');
        newDiscount.classList.add('discount');
        newDiscount.innerHTML = `
            <label for="discount_amount_${discountCount}">Discount ${discountCount} Amount:</label>
            <input type="number" step="0.01" name="discount_amount_${discountCount}">
            <label for="is_discount_taxable_${discountCount}">Is Taxable?</label>
            <select name="is_discount_taxable_${discountCount}">
                <option value="N">No</option>
                <option value="Y">Yes</option>
            </select>
        `;
        discountsContainer.appendChild(newDiscount);
    }

    function toggleShippingTaxRate() {
        const shippingTaxable = document.querySelector('select[name="shipping_taxable"]').value;
        const shippingTaxRateSection = document.getElementById('shipping_tax_rate_section');
        shippingTaxRateSection.style.display = shippingTaxable === 'Y' ? 'block' : 'none';
    }
</script>
{% endblock %}