name: Production Deployment Workflow

# STRICT PRODUCTION DEPLOYMENT
# This workflow deploys ONLY after:
# 1. All tests pass
# 2. Changes are tested in staging
# 3. PR is approved and merged to main
# 4. Manual approval is granted (if configured)

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_backup:
        description: 'Skip database backup (DANGEROUS - not recommended)'
        required: false
        type: boolean
        default: false

jobs:
  # Safety gate: Only deploy if PR was merged (not just closed)
  check-pr-merged:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Verify PR was merged
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
              echo "âŒ PR was closed but not merged. Aborting deployment."
              exit 1
            fi
            echo "âœ… PR was merged. Proceeding with deployment."
          else
            echo "âœ… Manual workflow dispatch. Proceeding with deployment."
          fi

  deploy-to-production:
    needs: check-pr-merged
    runs-on: ubuntu-latest
    environment:
      name: production
      # This creates a manual approval gate in GitHub
      # Requires repository settings: Settings > Environments > production > Required reviewers

    steps:
      - name: Production Deployment Notice
        run: |
          echo "=========================================="
          echo "âš ï¸  PRODUCTION DEPLOYMENT STARTING"
          echo "=========================================="
          echo "Target: omnitool-by-xdv (PRODUCTION)"
          echo "Branch: main"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "=========================================="

      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: main  # Always deploy from main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.0'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      - name: Login to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}
        run: |
          cat > ~/.netrc <<EOF
          machine api.heroku.com
            login $HEROKU_EMAIL
            password $HEROKU_API_KEY
          machine git.heroku.com
            login $HEROKU_EMAIL
            password $HEROKU_API_KEY
          EOF
          chmod 600 ~/.netrc
          heroku auth:whoami

      # CRITICAL: Backup production database before ANY changes
      - name: Backup Production Database
        if: ${{ !inputs.skip_backup }}
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "=========================================="
          echo "ğŸ“¦ CREATING PRODUCTION DATABASE BACKUP"
          echo "=========================================="

          # Create backup
          heroku pg:backups:capture -a omnitool-by-xdv

          # Get latest backup info
          BACKUP_INFO=$(heroku pg:backups -a omnitool-by-xdv --json | jq -r '.[0] | "ID: \(.name) | Size: \(.size) | Created: \(.created_at)"')

          echo "âœ… Production backup created:"
          echo "$BACKUP_INFO"
          echo ""
          echo "âš ï¸  If deployment fails, rollback with:"
          echo "   python scripts/rollback_migration.py --env production"
          echo "=========================================="

      - name: Skip Backup Warning
        if: ${{ inputs.skip_backup }}
        run: |
          echo "=========================================="
          echo "âš ï¸  WARNING: DATABASE BACKUP SKIPPED"
          echo "=========================================="
          echo "This is DANGEROUS in production!"
          echo "If migration fails, rollback may not be possible."
          echo "=========================================="

      - name: Add Heroku Remote
        run: heroku git:remote -a omnitool-by-xdv

      # Export tested tool_access from staging (not from dev!)
      # This ensures we deploy what was actually tested in staging
      - name: Export Staging Tool Access (Tested State)
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "=========================================="
          echo "ğŸ“¤ EXPORTING TESTED TOOL ACCESS FROM STAGING"
          echo "=========================================="

          # Export current staging state (this was tested)
          heroku run python scripts/export_tool_access.py \
            --env staging \
            --output /tmp/staging_tool_access.json \
            -a omnitool-by-xdv-staging

          # Download exported file
          # Note: This requires the script to output to a location accessible via Heroku
          # Alternative: Use the dev export if staging export is not feasible

          echo "âœ… Staging tool access exported"
          echo "This is the TESTED state that will be applied to production"
          echo "=========================================="

      # Deploy code to Heroku
      - name: Deploy to Heroku Production
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "=========================================="
          echo "ğŸš€ DEPLOYING CODE TO PRODUCTION"
          echo "=========================================="

          git push heroku main:main

          echo "âœ… Code deployed to production"
          echo "=========================================="

      - name: Update Heroku Config (Production)
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "Updating production environment variables..."

          heroku config:set FLASK_APP="main.py" -a omnitool-by-xdv
          heroku config:set FLASK_ENV="production" -a omnitool-by-xdv
          heroku config:set IS_LOCAL="false" -a omnitool-by-xdv
          heroku config:set MAIL_USERNAME="info.omnitools@gmail.com" -a omnitool-by-xdv
          heroku config:set MAIL_DEFAULT_SENDER="info@theomnitools.com" -a omnitool-by-xdv
          heroku config:set MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}" -a omnitool-by-xdv
          heroku config:set TOKEN_SECRET_KEY="${{ secrets.TOKEN_SECRET_KEY }}" -a omnitool-by-xdv
          heroku config:set SECURITY_PASSWORD_SALT="${{ secrets.SECURITY_PASSWORD_SALT }}" -a omnitool-by-xdv
          heroku config:set SESSION_TYPE="filesystem" -a omnitool-by-xdv

          echo "âœ… Environment variables updated"

      # Run database migrations
      - name: Run Database Migrations (Production)
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          FLASK_ENV: production
        run: |
          echo "=========================================="
          echo "ğŸ”„ RUNNING DATABASE MIGRATIONS"
          echo "=========================================="

          # Run migrate_db.py which includes:
          # 1. Schema migrations (Flask-Migrate)
          # 2. Tool synchronization (sync_tools.py)
          heroku run python migrate_db.py -a omnitool-by-xdv

          echo "âœ… Database migrations completed"
          echo "=========================================="

      # Import tool_access from tested staging state
      - name: Import Tool Access Permissions (Production)
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "=========================================="
          echo "ğŸ” IMPORTING TOOL ACCESS PERMISSIONS"
          echo "=========================================="

          # Use the dev export (which was tested in staging)
          # In production, we import in MERGE mode (never overwrite)
          if [ -f "data/tool_access_exports/dev_tool_access.json" ]; then
            heroku run python scripts/import_tool_access.py \
              --source data/tool_access_exports/dev_tool_access.json \
              --mode merge \
              -a omnitool-by-xdv

            echo "âœ… Tool access permissions imported (merge mode)"
          else
            echo "âš ï¸  WARNING: No dev_tool_access.json found"
            echo "Tool access permissions NOT updated in production"
            echo "Existing production permissions preserved"
          fi

          echo "=========================================="

      # Verify deployment success
      - name: Verify Migration (Production)
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "=========================================="
          echo "ğŸ” VERIFYING PRODUCTION DEPLOYMENT"
          echo "=========================================="

          # Run verification checks
          heroku run python scripts/verify_migration.py --env production -a omnitool-by-xdv || {
            echo "âŒ VERIFICATION FAILED"
            echo "âš ï¸  Production may have issues - investigate immediately"
            echo "Rollback command: python scripts/rollback_migration.py --env production"
            exit 1
          }

          echo "âœ… Verification passed"
          echo "=========================================="

      # Run smoke tests on production
      - name: Run Production Smoke Tests
        env:
          PRODUCTION_URL: https://omnitool-by-xdv-85a1bde25ad1.herokuapp.com
        run: |
          echo "=========================================="
          echo "ğŸ§ª RUNNING PRODUCTION SMOKE TESTS"
          echo "=========================================="

          python tests/smoke_tests.py --url $PRODUCTION_URL || {
            echo "âŒ SMOKE TESTS FAILED"
            echo "âš ï¸  Production deployment may have issues"
            echo "Check application logs: heroku logs --tail -a omnitool-by-xdv"
            exit 1
          }

          echo "âœ… Smoke tests passed"
          echo "=========================================="

      # Cleanup old backups (keep last 10)
      - name: Cleanup Old Backups
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "Cleaning up old backups (keep last 10)..."

          # Get backup count
          BACKUP_COUNT=$(heroku pg:backups -a omnitool-by-xdv --json | jq 'length')

          if [ "$BACKUP_COUNT" -gt 10 ]; then
            echo "Found $BACKUP_COUNT backups. Deleting oldest..."

            # Delete backups older than the 10 most recent
            heroku pg:backups -a omnitool-by-xdv --json | \
              jq -r '.[10:] | .[].name' | \
              xargs -I {} heroku pg:backups:delete {} -a omnitool-by-xdv --confirm omnitool-by-xdv || true

            echo "âœ… Old backups cleaned up"
          else
            echo "Only $BACKUP_COUNT backups exist. No cleanup needed."
          fi

      # Final deployment summary
      - name: Production Deployment Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "âœ… PRODUCTION DEPLOYMENT SUCCESSFUL"
          echo "=========================================="
          echo "ğŸ”— Production URL: https://omnitool-by-xdv-85a1bde25ad1.herokuapp.com"
          echo "ğŸ“Š Deployment Time: $(date -u)"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo ""
          echo "ğŸ“‹ Post-Deployment Actions:"
          echo "  1. âœ… Code deployed"
          echo "  2. âœ… Database migrations applied"
          echo "  3. âœ… Tool access permissions synced"
          echo "  4. âœ… Verification checks passed"
          echo "  5. âœ… Smoke tests passed"
          echo ""
          echo "ğŸ” Monitor Production:"
          echo "   heroku logs --tail -a omnitool-by-xdv"
          echo ""
          echo "ğŸ“¦ Rollback (if needed):"
          echo "   python scripts/rollback_migration.py --env production"
          echo "=========================================="

      # Failure notification
      - name: Deployment Failure Notice
        if: failure()
        run: |
          echo ""
          echo "=========================================="
          echo "âŒ PRODUCTION DEPLOYMENT FAILED"
          echo "=========================================="
          echo "âš ï¸  CRITICAL: Production deployment encountered errors"
          echo ""
          echo "ğŸš¨ Immediate Actions Required:"
          echo "  1. Check production status:"
          echo "     heroku open -a omnitool-by-xdv"
          echo ""
          echo "  2. Review error logs:"
          echo "     heroku logs --tail -a omnitool-by-xdv"
          echo ""
          echo "  3. Consider rollback if production is down:"
          echo "     python scripts/rollback_migration.py --env production"
          echo ""
          echo "  4. Check GitHub Actions logs for failure details"
          echo ""
          echo "=========================================="

      # Optional: Discord notification (if configured)
      # - name: Send Discord Notification
      #   if: always()
      #   env:
      #     DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      #   run: |
      #     STATUS="${{ job.status }}"
      #     if [ "$STATUS" == "success" ]; then
      #       MESSAGE="âœ… Production deployment successful"
      #       COLOR="3066993"
      #     else
      #       MESSAGE="âŒ Production deployment failed"
      #       COLOR="15158332"
      #     fi
      #
      #     curl -H "Content-Type: application/json" \
      #       -d "{\"embeds\": [{\"title\": \"$MESSAGE\", \"color\": $COLOR, \"description\": \"Commit: ${{ github.sha }}\"}]}" \
      #       $DISCORD_WEBHOOK
