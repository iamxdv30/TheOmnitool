name: CI/CD Workflow

on:
  push:
    branches:
      - development

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      MAIL_USERNAME: info.omnitools@gmail.com
      MAIL_DEFAULT_SENDER: info@theomnitools.com
      MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
      TOKEN_SECRET_KEY: ${{ secrets.TOKEN_SECRET_KEY }}
      SECURITY_PASSWORD_SALT: ${{ secrets.SECURITY_PASSWORD_SALT }}
      DATABASE_URL: 'sqlite:///:memory:'
      FLASK_APP: 'main.py'
      FLASK_ENV: 'testing'
      IS_LOCAL: 'true'
      SESSION_TYPE: 'filesystem'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.0'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-flask-sqlalchemy pytest-env

      - name: Create Test Config
        run: |
          echo "TESTING=True" > .env.test
          echo "TOKEN_SECRET_KEY=${{ secrets.TOKEN_SECRET_KEY }}" >> .env.test
          echo "SESSION_TYPE=filesystem" >> .env.test
          mkdir -p instance

      - name: Run Tests
        env:
          FLASK_ENV: testing
          TESTING: true
          TOKEN_SECRET_KEY: ${{ secrets.TOKEN_SECRET_KEY }}
          SESSION_TYPE: filesystem
        run: |
          pytest --cov=./ --cov-report=html

      - name: Archive code coverage results
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report
          path: htmlcov/
          retention-days: 14

  deploy-to-staging:
    runs-on: ubuntu-latest
    needs: test
    environment: staging

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.0'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Push to Staging Branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git checkout -b staging
          git push origin staging --force

      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      - name: Login to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}
        run: |
          cat > ~/.netrc <<EOF
          machine api.heroku.com
            login $HEROKU_EMAIL
            password $HEROKU_API_KEY
          machine git.heroku.com
            login $HEROKU_EMAIL
            password $HEROKU_API_KEY
          EOF
          chmod 600 ~/.netrc
          heroku auth:whoami

      - name: Add Heroku Remote
        run: heroku git:remote -a omnitool-by-xdv-staging

      - name: Deploy to Heroku
        run: git push heroku staging:main --force

      - name: Update Heroku Config
        run: |
          heroku config:set FLASK_APP="main.py" -a omnitool-by-xdv-staging
          heroku config:set FLASK_ENV="staging" -a omnitool-by-xdv-staging
          heroku config:set IS_LOCAL="false" -a omnitool-by-xdv-staging
          heroku config:set MAIL_USERNAME="info.omnitools@gmail.com" -a omnitool-by-xdv-staging
          heroku config:set MAIL_DEFAULT_SENDER="info@theomnitools.com" -a omnitool-by-xdv-staging
          heroku config:set MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}" -a omnitool-by-xdv-staging
          heroku config:set TOKEN_SECRET_KEY="${{ secrets.TOKEN_SECRET_KEY }}" -a omnitool-by-xdv-staging
          heroku config:set SECURITY_PASSWORD_SALT="${{ secrets.SECURITY_PASSWORD_SALT }}" -a omnitool-by-xdv-staging
          heroku config:set SESSION_TYPE="filesystem" -a omnitool-by-xdv-staging

      # OPTIONAL: Sync production data to staging for realistic testing
      # Requires Heroku Postgres Standard tier ($50+/month) for follower support
      # Uncomment the following step to enable prod->staging data sync:
      #
      # - name: Sync Production Data to Staging
      #   env:
      #     HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      #   run: |
      #     python scripts/sync_data_prod_to_staging.py
      #   continue-on-error: false

      - name: Backup Staging Database
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "Creating staging database backup..."
          heroku pg:backups:capture -a omnitool-by-xdv-staging
          echo "‚úÖ Staging backup created"

      - name: Run Database Migrations
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          FLASK_ENV: staging
        run: |
          heroku run python migrate_db.py -a omnitool-by-xdv-staging

      - name: Import Tool Access Permissions
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "Importing tool_access permissions from dev export..."
          if [ -f "data/tool_access_exports/dev_tool_access.json" ]; then
            heroku run python scripts/import_tool_access.py \
              --source data/tool_access_exports/dev_tool_access.json \
              --mode merge \
              -a omnitool-by-xdv-staging
            echo "‚úÖ Tool access permissions imported"
          else
            echo "‚ö†Ô∏è  No dev_tool_access.json found. Skipping tool access import."
            echo "   Export tool access using: python scripts/export_tool_access.py --env local"
          fi

      - name: Verify Migration
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "Running post-deployment verification..."
          heroku run python scripts/verify_migration.py --env staging -a omnitool-by-xdv-staging || echo "[WARNING] Verification had failures - check output above"

      - name: Run Staging Smoke Tests
        env:
          STAGING_URL: https://omnitool-by-xdv-staging.herokuapp.com
        run: |
          echo "=========================================="
          echo "üß™ RUNNING STAGING SMOKE TESTS"
          echo "=========================================="
          python tests/smoke_tests.py --url $STAGING_URL || {
            echo "‚ö†Ô∏è  WARNING: Smoke tests failed in staging"
            echo "Check staging logs: heroku logs --tail -a omnitool-by-xdv-staging"
            exit 1
          }
          echo "‚úÖ Smoke tests passed"
          echo "=========================================="

      - name: Deployment Summary
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ STAGING DEPLOYMENT COMPLETE"
          echo "=========================================="
          echo "üîó Staging URL: https://omnitool-by-xdv-staging.herokuapp.com"
          echo ""
          echo "üìã Next Steps:"
          echo "  1. Verify staging environment manually"
          echo "  2. Test tool functionality"
          echo "  3. Verify tool access permissions"
          echo "  4. If all tests pass, create PR to main for production deployment"
          echo "=========================================="
